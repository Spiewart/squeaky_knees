name: Deploy to DigitalOcean

on:
  push:
    branches: [main]
    paths-ignore: ['docs/**', '**.md']

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/squeaky_knees

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: DigitalOcean

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set lowercase image name
        run: echo "IMAGE_NAME_LOWER=$(echo ${{ env.IMAGE_NAME }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:latest \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:${{ github.sha }} \
            .

      - name: Push image to GHCR
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:${{ github.sha }}

      - name: Deploy to Droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Login to GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Set lowercase image name
            IMAGE_NAME_LOWER=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')

            # Pull latest image
            docker pull ${{ env.REGISTRY }}/${IMAGE_NAME_LOWER}:latest

            # Stop and remove old container
            docker stop squeaky-knees || true
            docker rm squeaky-knees || true

            # Run migrations
            docker run --rm \
              --env-file /opt/squeaky_knees/.envs/.production/.django \
              --env-file /opt/squeaky_knees/.envs/.production/.postgres \
              --network squeaky_knees_network \
              ${{ env.REGISTRY }}/${IMAGE_NAME_LOWER}:latest \
              uv run python manage.py migrate --noinput

            # Start new container
            docker run -d \
              --name squeaky-knees \
              --restart unless-stopped \
              --env-file /opt/squeaky_knees/.envs/.production/.django \
              --env-file /opt/squeaky_knees/.envs/.production/.postgres \
              --network squeaky_knees_network \
              -p 8000:8000 \
              ${{ env.REGISTRY }}/${IMAGE_NAME_LOWER}:latest

            # Clean up old images
            docker image prune -af

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== Waiting for container to start ==="
            sleep 10

            echo "=== Checking if container is running ==="
            if ! docker ps | grep squeaky-knees; then
              echo "ERROR: Container not running!"
              echo "=== Container logs ==="
              docker logs squeaky-knees 2>&1 | tail -50 || echo "No logs available"
              echo "=== All containers ==="
              docker ps -a
              exit 1
            fi

            echo "=== Container is running ==="
            docker ps | grep squeaky-knees

            echo "=== Testing health endpoint (with retries) ==="
            for i in {1..30}; do
              if curl -sf http://localhost:8000/health/ | grep -q '"status":"ok"'; then
                echo "âœ… Health check passed!"
                exit 0
              fi
              echo "Attempt $i/30 failed, waiting 2s..."
              sleep 2
            done

            echo "ERROR: Health check failed after 30 attempts"
            echo "=== Container logs ==="
            docker logs squeaky-knees 2>&1 | tail -100
            exit 1
