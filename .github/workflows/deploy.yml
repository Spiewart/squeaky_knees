name: Deploy to DigitalOcean

on:
  push:
    branches: [main]
    paths-ignore: ['docs/**', '**.md']

env:
  REGISTRY: registry.digitalocean.com
  IMAGE_NAME: squeaky-knees

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: DigitalOcean

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: echo "${{ secrets.DO_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ secrets.DO_TOKEN }} --password-stdin

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ secrets.REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:latest \
            -t ${{ env.REGISTRY }}/${{ secrets.REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            .

      - name: Clean up old DOCR images (before push)
        run: |
          # Get list of all tags for this image
          TAGS=$(doctl registry repository list-tags ${{ secrets.REGISTRY_NAME }}/${{ env.IMAGE_NAME }} --format Tag --no-header 2>/dev/null | grep -v "latest" | sort -r | tail -n +6)

          # Delete tags older than the last 5 (keep latest, plus 4 backups)
          for tag in $TAGS; do
            echo "Deleting old tag: $tag"
            doctl registry repository delete-tag ${{ secrets.REGISTRY_NAME }}/${{ env.IMAGE_NAME }} $tag --force || true
          done

          # Run garbage collection to free up space
          echo "Running garbage collection..."
          doctl registry garbage-collection start --include-untagged-manifests --force || true

          # Wait a moment for GC to complete
          sleep 10

      - name: Push image to DOCR
        run: |
          docker push ${{ env.REGISTRY }}/${{ secrets.REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ secrets.REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Deploy to Droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Login to registry
            docker login -u ${{ secrets.DO_TOKEN }} -p ${{ secrets.DO_TOKEN }} ${{ env.REGISTRY }}

            # Pull latest image
            docker pull ${{ env.REGISTRY }}/${{ secrets.REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:latest

            # Stop and remove old container
            docker stop squeaky-knees || true
            docker rm squeaky-knees || true

            # Run migrations
            docker run --rm \
              --env-file /opt/squeaky_knees/.envs/.production/.django \
              --env-file /opt/squeaky_knees/.envs/.production/.postgres \
              --network squeaky_knees_network \
              ${{ env.REGISTRY }}/${{ secrets.REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:latest \
              uv run python manage.py migrate --noinput

            # Start new container
            docker run -d \
              --name squeaky-knees \
              --restart unless-stopped \
              --env-file /opt/squeaky_knees/.envs/.production/.django \
              --env-file /opt/squeaky_knees/.envs/.production/.postgres \
              --network squeaky_knees_network \
              -p 8000:8000 \
              ${{ env.REGISTRY }}/${{ secrets.REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:latest

            # Clean up old images
            docker image prune -af

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== Waiting for container to start ==="
            sleep 10

            echo "=== Checking if container is running ==="
            if ! docker ps | grep squeaky-knees; then
              echo "ERROR: Container not running!"
              echo "=== Container logs ==="
              docker logs squeaky-knees 2>&1 | tail -50 || echo "No logs available"
              echo "=== All containers ==="
              docker ps -a
              exit 1
            fi

            echo "=== Container is running ==="
            docker ps | grep squeaky-knees

            echo "=== Testing health endpoint (with retries) ==="
            for i in {1..30}; do
              if curl -sf http://localhost:8000/health/ | grep -q '"status":"ok"'; then
                echo "âœ… Health check passed!"
                exit 0
              fi
              echo "Attempt $i/30 failed, waiting 2s..."
              sleep 2
            done

            echo "ERROR: Health check failed after 30 attempts"
            echo "=== Container logs ==="
            docker logs squeaky-knees 2>&1 | tail -100
            exit 1
