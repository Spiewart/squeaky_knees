name: Deploy to DigitalOcean

on:
  push:
    branches: [main]
    paths-ignore: ['docs/**', '**.md']
  workflow_dispatch:
    description: 'Manually trigger deployment'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/squeaky_knees

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: DigitalOcean
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set lowercase image name
        run: echo "IMAGE_NAME_LOWER=$(echo ${{ env.IMAGE_NAME }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:latest \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:${{ github.sha }} \
            .

      - name: Push image to GHCR
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:${{ github.sha }}

      - name: Deploy to Droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Login to GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Set lowercase image name
            IMAGE_NAME_LOWER=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')

            # Pull latest image
            docker pull ${{ env.REGISTRY }}/${IMAGE_NAME_LOWER}:latest

            # Check for required environment files
            if [ ! -f /opt/squeaky_knees/.envs/.production/.django ]; then
              echo "ERROR: Missing /opt/squeaky_knees/.envs/.production/.django"
              exit 1
            fi
            if [ ! -f /opt/squeaky_knees/.envs/.production/.postgres ]; then
              echo "ERROR: Missing /opt/squeaky_knees/.envs/.production/.postgres"
              exit 1
            fi

            # Load PostgreSQL environment variables
            set -a
            source /opt/squeaky_knees/.envs/.production/.postgres
            set +a

            # Ensure Docker network exists
            docker network create squeaky_knees_network 2>/dev/null || true

            # Ensure PostgreSQL container is set up and running
            if ! docker ps -a --format '{{.Names}}' | grep -q '^postgres$'; then
              echo "=== Setting up PostgreSQL container ==="
              docker volume create postgres_data || true
              docker run -d \
                --name postgres \
                --restart unless-stopped \
                --network squeaky_knees_network \
                -v postgres_data:/var/lib/postgresql/data \
                -e POSTGRES_DB="${POSTGRES_DB}" \
                -e POSTGRES_USER="${POSTGRES_USER}" \
                -e POSTGRES_PASSWORD="${POSTGRES_PASSWORD}" \
                postgres:16
              echo "Waiting for PostgreSQL to be ready..."
              sleep 10
            elif ! docker ps --format '{{.Names}}' | grep -q '^postgres$'; then
              echo "=== Starting existing PostgreSQL container ==="
              docker start postgres
              sleep 5
            else
              echo "=== PostgreSQL container is already running ==="
            fi

            # Verify PostgreSQL is accessible
            docker exec postgres pg_isready -U "${POSTGRES_USER}" || {
              echo "ERROR: PostgreSQL is not ready"
              docker logs postgres --tail 20
              exit 1
            }

            # Stop and remove old application container
            docker stop squeaky-knees || true
            docker rm squeaky-knees || true

            # Run migrations
            docker run --rm \
              --env-file /opt/squeaky_knees/.envs/.production/.django \
              --env-file /opt/squeaky_knees/.envs/.production/.postgres \
              --network squeaky_knees_network \
              ${{ env.REGISTRY }}/${IMAGE_NAME_LOWER}:latest \
              uv run python manage.py migrate --noinput

            # Start new container
            docker run -d \
              --name squeaky-knees \
              --restart unless-stopped \
              --env-file /opt/squeaky_knees/.envs/.production/.django \
              --env-file /opt/squeaky_knees/.envs/.production/.postgres \
              --network squeaky_knees_network \
              -p 8000:8000 \
              ${{ env.REGISTRY }}/${IMAGE_NAME_LOWER}:latest

            # Clean up old images
            docker image prune -af

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== Waiting for container to start ==="
            sleep 10

            echo "=== Checking if container is running ==="
            if ! docker ps | grep squeaky-knees; then
              echo "ERROR: Container not running!"
              echo "=== Container logs ==="
              docker logs squeaky-knees 2>&1 | tail -50 || echo "No logs available"
              echo "=== All containers ==="
              docker ps -a
              exit 1
            fi

            echo "=== Container is running ==="
            docker ps | grep squeaky-knees

            echo "=== Testing health endpoint (with retries) ==="
            for i in {1..30}; do
              if curl -sf http://localhost:8000/health/ | grep -q '"status":"ok"'; then
                echo "âœ… Health check passed!"
                exit 0
              fi
              echo "Attempt $i/30 failed, waiting 2s..."
              sleep 2
            done

            echo "ERROR: Health check failed after 30 attempts"
            echo "=== Container logs ==="
            docker logs squeaky-knees 2>&1 | tail -100
            exit 1
