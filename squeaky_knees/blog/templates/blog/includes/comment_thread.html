{% load wagtailcore_tags %}

{% comment %}
Recursive template for displaying nested comments.
This template displays a single comment and all its direct replies.
{% endcomment %}
<div class="comment-thread"
     style="margin-left: {{ comment.get_depth|add:0 }}rem">
  <div class="card mb-3 comment-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h6 class="card-subtitle mb-2 text-muted">
            <strong>{{ comment.author.username }}</strong>
            {% if comment.is_reply %}<span class="badge bg-info">Replied</span>{% endif %}
          </h6>
          <p class="card-subtitle mb-2 text-muted comment-timestamp">{{ comment.created|date:"F d, Y H:i" }}</p>
        </div>
      </div>
      <div class="card-text comment-content">
        {% for block in comment.text %}
          {% include_block block %}
        {% endfor %}
      </div>
      {% if user.is_authenticated %}
        <div class="mt-3">
          <a href="#reply-to-{{ comment.id }}"
             class="btn btn-sm btn-outline-secondary"
             onclick="toggleReplyForm({{ comment.id }})">Reply</a>
        </div>
        <!-- Reply form (hidden by default) -->
        <div id="reply-to-{{ comment.id }}"
             class="reply-form mt-3 reply-form-hidden"
             style="margin-left: {{ comment.get_depth|add:1 }}rem">
          <form method="post"
                action="{% url 'blog:add_comment' page.id %}"
                data-recaptcha-sitekey="{{ recaptcha_site_key|default:'' }}">
            {% csrf_token %}
            <input type="hidden" name="parent_id" value="{{ comment.id }}" />
            <div class="mb-3" id="reply-blocks-{{ comment.id }}">
              <div class="reply-block" data-block-type="rich_text">
                <div class="d-flex justify-content-between align-items-center">
                  <label class="form-label mb-0">Text</label>
                  <button type="button"
                          class="btn btn-sm btn-link text-danger remove-reply-block">Remove</button>
                </div>
                <div class="btn-group btn-group-sm mb-2"
                     role="group"
                     aria-label="Text formatting">
                  <button type="button"
                          class="btn btn-outline-secondary reply-format"
                          data-cmd="bold">
                    <strong>B</strong>
                  </button>
                  <button type="button"
                          class="btn btn-outline-secondary reply-format"
                          data-cmd="italic">
                    <em>I</em>
                  </button>
                  <button type="button"
                          class="btn btn-outline-secondary reply-format"
                          data-cmd="createLink">Link</button>
                </div>
                <div class="form-control reply-block-input"
                     contenteditable="true"
                     data-input-type="rich"></div>
              </div>
            </div>
            <div class="mb-3 d-flex gap-2">
              <button type="button"
                      class="btn btn-outline-secondary btn-sm add-reply-text-block"
                      data-comment-id="{{ comment.id }}">Add Text</button>
              <button type="button"
                      class="btn btn-outline-secondary btn-sm add-reply-code-block"
                      data-comment-id="{{ comment.id }}">Add Code</button>
            </div>
            <input type="hidden" name="text" class="reply-text-input" value="[]" />
            <input type="hidden" name="captcha" class="reply-captcha-input" value="" />
            <button type="submit" class="btn btn-sm btn-primary">Submit Reply</button>
            <button type="button"
                    class="btn btn-sm btn-secondary"
                    onclick="toggleReplyForm({{ comment.id }})">Cancel</button>
          </form>
        </div>
      {% endif %}
    </div>
  </div>
  <!-- Display direct replies -->
  {% for reply in comment.replies.all %}
    {% if reply.approved %}
      {% include "blog/includes/comment_thread.html" with comment=reply %}
    {% endif %}
  {% endfor %}
</div>
<script>
  (function() {
    if (window.__replyFormHandlersInitialized) {
      return;
    }
    window.__replyFormHandlersInitialized = true;
    window.toggleReplyForm = function(commentId) {
      const form = document.getElementById('reply-to-' + commentId);
      if (form) {
        form.classList.toggle('reply-form-hidden');
      }
    };

    function createReplyTextBlock(commentId) {
      const wrapper = document.createElement("div");
      wrapper.className = "reply-block";
      wrapper.dataset.blockType = "rich_text";
      wrapper.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <label class="form-label mb-0">Text</label>
        <button type="button" class="btn btn-sm btn-link text-danger remove-reply-block">Remove</button>
      </div>
      <div class="btn-group btn-group-sm mb-2" role="group" aria-label="Text formatting">
        <button type="button" class="btn btn-outline-secondary reply-format" data-cmd="bold"><strong>B</strong></button>
        <button type="button" class="btn btn-outline-secondary reply-format" data-cmd="italic"><em>I</em></button>
        <button type="button" class="btn btn-outline-secondary reply-format" data-cmd="createLink">Link</button>
      </div>
      <div class="form-control reply-block-input" contenteditable="true" data-input-type="rich" style="min-height: 100px;"></div>
    `;
      return wrapper;
    }

    function createReplyCodeBlock(commentId) {
      const wrapper = document.createElement("div");
      wrapper.className = "reply-block";
      wrapper.dataset.blockType = "code";
      wrapper.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <label class="form-label mb-0">Code</label>
        <button type="button" class="btn btn-sm btn-link text-danger remove-reply-block">Remove</button>
      </div>
      <input type="text" class="form-control reply-code-language mb-2" placeholder="Language (e.g., python, javascript)" />
      <textarea class="form-control reply-block-input" rows="6" placeholder="Paste code here..."></textarea>
    `;
      return wrapper;
    }

    function initReplyFormHandlers() {
      document.addEventListener('click', (event) => {
        const addTextBtn = event.target.closest('.add-reply-text-block');
        if (addTextBtn) {
          event.preventDefault();
          const commentId = addTextBtn.dataset.commentId;
          const blocksContainer = document.getElementById('reply-blocks-' + commentId);
          if (blocksContainer) {
            blocksContainer.appendChild(createReplyTextBlock(commentId));
          }
          return;
        }

        const addCodeBtn = event.target.closest('.add-reply-code-block');
        if (addCodeBtn) {
          event.preventDefault();
          const commentId = addCodeBtn.dataset.commentId;
          const blocksContainer = document.getElementById('reply-blocks-' + commentId);
          if (blocksContainer) {
            blocksContainer.appendChild(createReplyCodeBlock(commentId));
          }
          return;
        }

        const removeBtn = event.target.closest(".remove-reply-block");
        if (removeBtn) {
          event.preventDefault();
          const block = removeBtn.closest(".reply-block");
          if (block) block.remove();
        }
      });

      // Setup reply form submission
      document.querySelectorAll('.reply-form form').forEach((form) => {
        // Setup formatting buttons
        form.addEventListener('click', (event) => {
          const button = event.target.closest(".reply-format");
          if (!button) return;
          event.preventDefault();
          const cmd = button.dataset.cmd;
          if (!cmd) return;
          if (cmd === "createLink") {
            const url = prompt("Enter URL:");
            if (url) document.execCommand("createLink", false, url);
            return;
          }
          document.execCommand(cmd, false, null);
        });

        // Setup form submission
        form.addEventListener('submit', (e) => {
          const input = form.querySelector('.reply-text-input');
          const blocksContainer = form.querySelector('[id^="reply-blocks-"]');
          if (blocksContainer && input) {
            const blocks = [];
            blocksContainer.querySelectorAll(".reply-block").forEach((block) => {
              const type = block.dataset.blockType;
              const textArea = block.querySelector(".reply-block-input");
              const isRich = textArea && textArea.getAttribute("contenteditable") === "true";
              const value = textArea ?
                (isRich ? textArea.innerHTML.trim() : textArea.value.trim()) :
                "";
              if (!value) return;

              if (type === "code") {
                const langInput = block.querySelector(".reply-code-language");
                blocks.push({
                  type: "code",
                  value: {
                    language: langInput ? langInput.value.trim() : "",
                    code: value,
                  },
                });
              } else {
                blocks.push({
                  type: "rich_text",
                  value: value,
                });
              }
            });

            input.value = JSON.stringify(blocks);
          }

          const recaptchaInput = form.querySelector('input[name="captcha"]');
          const sitekey = form.dataset.recaptchaSitekey;
          if (recaptchaInput && (!recaptchaInput.value || recaptchaInput.value.trim() === "") && window.grecaptcha && sitekey) {
            if (form.dataset.recaptchaPending === "true") {
              return;
            }
            e.preventDefault();
            form.dataset.recaptchaPending = "true";
            window.grecaptcha.execute(sitekey, {
                action: 'comments'
              })
              .then((token) => {
                recaptchaInput.value = token;
                form.dataset.recaptchaPending = "";
                form.submit();
              })
              .catch(() => {
                form.dataset.recaptchaPending = "";
              });
          }
        });
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initReplyFormHandlers);
    } else {
      initReplyFormHandlers();
    }
  })();
</script>
