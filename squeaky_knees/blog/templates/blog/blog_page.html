{% extends "base.html" %}

{% load static wagtailcore_tags crispy_forms_tags %}

{% block title %}{{ page.title }}{% endblock %}
{% block content %}
  <div class="container mt-4">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        <article>
          {% if page.header_image %}
            <img src="{{ page.header_image.file.url }}"
                 class="img-fluid mb-4"
                 alt="{{ page.title }}" />
          {% endif %}
          <h1>{{ page.title }}</h1>
          <p class="text-muted">
            <small>Published on {{ page.date }}</small>
          </p>
          {% if page.tags.all %}
            <div class="mb-3">
              {% for tag in page.tags.all %}<span class="badge bg-secondary">{{ tag }}</span>{% endfor %}
            </div>
          {% endif %}
          <div class="lead">{{ page.intro }}</div>
          <hr />
          <div class="blog-content">
            {% for block in page.body %}
              {% include_block block %}
            {% endfor %}
          </div>
        </article>
        <hr class="my-5" />
        <!-- Comments Section -->
        <div class="comments-section">
          <h3>Comments</h3>
          {% if comments %}
            {% comment %}Display nested comments recursively{% endcomment %}
            {% for comment in comments %}
              {% include "blog/includes/comment_thread.html" with comment=comment comment_form=comment_form %}
            {% endfor %}
          {% else %}
            <p>No comments yet. Be the first to comment!</p>
          {% endif %}
          {% if user.is_authenticated %}
            <h4 class="mt-4">Leave a Comment</h4>
            <form method="post" action="{% url 'blog:add_comment' page.id %}">
              {% csrf_token %}
              {{ comment_form.text }}
              <div class="mb-3" id="comment-blocks">
                <div class="comment-block" data-block-type="rich_text">
                  <div class="d-flex justify-content-between align-items-center">
                    <label class="form-label mb-0">Text</label>
                    <button type="button" class="btn btn-sm btn-link text-danger remove-comment-block">Remove</button>
                  </div>
                  <div class="btn-group btn-group-sm mb-2" role="group" aria-label="Text formatting">
                    <button type="button" class="btn btn-outline-secondary comment-format" data-cmd="bold"><strong>B</strong></button>
                    <button type="button" class="btn btn-outline-secondary comment-format" data-cmd="italic"><em>I</em></button>
                    <button type="button" class="btn btn-outline-secondary comment-format" data-cmd="createLink">Link</button>
                  </div>
                  <div class="form-control comment-block-input" contenteditable="true" data-input-type="rich" style="min-height: 120px;"></div>
                </div>
              </div>
              <div class="mb-3 d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="add-text-block">Add Text</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="add-code-block">Add Code</button>
              </div>
              {{ comment_form.captcha }}
              <button type="submit" class="btn btn-primary">Submit Comment</button>
            </form>
            <p class="text-muted mt-2">
              <small>Note: Comments are reviewed by moderators before being published.</small>
            </p>
          {% else %}
            <p class="alert alert-info mt-4">
              <a href="{% url 'account_login' %}?next={{ request.path }}">Log in</a> to leave a comment.
            </p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <script>
    (function () {
      const blocksContainer = document.getElementById("comment-blocks");
      const addTextBtn = document.getElementById("add-text-block");
      const addCodeBtn = document.getElementById("add-code-block");
      const jsonField = document.getElementById("comment-text-json");

      if (!blocksContainer || !addTextBtn || !addCodeBtn || !jsonField) return;

      const createTextBlock = () => {
        const wrapper = document.createElement("div");
        wrapper.className = "comment-block";
        wrapper.dataset.blockType = "rich_text";
        wrapper.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <label class="form-label mb-0">Text</label>
            <button type="button" class="btn btn-sm btn-link text-danger remove-comment-block">Remove</button>
          </div>
          <div class="btn-group btn-group-sm mb-2" role="group" aria-label="Text formatting">
            <button type="button" class="btn btn-outline-secondary comment-format" data-cmd="bold"><strong>B</strong></button>
            <button type="button" class="btn btn-outline-secondary comment-format" data-cmd="italic"><em>I</em></button>
            <button type="button" class="btn btn-outline-secondary comment-format" data-cmd="createLink">Link</button>
          </div>
          <div class="form-control comment-block-input" contenteditable="true" data-input-type="rich" style="min-height: 120px;"></div>
        `;
        return wrapper;
      };

      const createCodeBlock = () => {
        const wrapper = document.createElement("div");
        wrapper.className = "comment-block";
        wrapper.dataset.blockType = "code";
        wrapper.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <label class="form-label mb-0">Code</label>
            <button type="button" class="btn btn-sm btn-link text-danger remove-comment-block">Remove</button>
          </div>
          <input type="text" class="form-control comment-code-language mb-2" placeholder="Language (e.g., python, javascript)">
          <textarea class="form-control comment-block-input" rows="6" placeholder="Paste code here..."></textarea>
        `;
        return wrapper;
      };

      addTextBtn.addEventListener("click", () => {
        blocksContainer.appendChild(createTextBlock());
      });

      addCodeBtn.addEventListener("click", () => {
        blocksContainer.appendChild(createCodeBlock());
      });

      const form = jsonField.closest("form");
      form.addEventListener("click", (event) => {
        const button = event.target.closest(".comment-format");
        if (!button) return;
        event.preventDefault();
        const cmd = button.dataset.cmd;
        if (!cmd) return;
        if (cmd === "createLink") {
          const url = prompt("Enter URL:");
          if (url) document.execCommand("createLink", false, url);
          return;
        }
        document.execCommand(cmd, false, null);
      });

      form.addEventListener("click", (event) => {
        const removeBtn = event.target.closest(".remove-comment-block");
        if (!removeBtn) return;
        event.preventDefault();
        const block = removeBtn.closest(".comment-block");
        if (block) block.remove();
      });

      form.addEventListener("submit", () => {
        const blocks = [];
        blocksContainer.querySelectorAll(".comment-block").forEach((block) => {
          const type = block.dataset.blockType;
          const textArea = block.querySelector(".comment-block-input");
          const isRich = textArea && textArea.getAttribute("contenteditable") === "true";
          const value = textArea
            ? (isRich ? textArea.innerHTML.trim() : textArea.value.trim())
            : "";
          if (!value) return;

          if (type === "code") {
            const langInput = block.querySelector(".comment-code-language");
            blocks.push({
              type: "code",
              value: {
                language: langInput ? langInput.value.trim() : "",
                code: value,
              },
            });
          } else {
            blocks.push({
              type: "rich_text",
              value: value,
            });
          }
        });

        jsonField.value = JSON.stringify(blocks);
      });
    })();
  </script>
{% endblock content %}
